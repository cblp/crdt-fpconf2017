<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>CRDT &lt;> Haskell</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <style media="screen">
      section img.element {
        background: transparent;
        border: 0;
        vertical-align: middle;
      }
      table.td-center td {
        text-align: center;
      }
      table.figure td {
        width: 20%;
        text-align: center;
        font-size: 200%;
      }
      .term {color: #99f;}
      .term-def {color: #9f9;}
    </style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-markdown>
          # CRDT &lt;> Haskell
          Юрий Сыровецкий, Николай Логинов
        </section>

        <section>
          <h3 data-fragment-index=1>Распределённая система</h3>
          <table class=figure>
            <tr>
              <td data-fragment-index=1>
                <img class="element" src="database.png" alt="DB" border=0>
              </td>
              <td data-fragment-index=2>⇆</td>
              <td>
                <img class="element" src="database.png" alt="DB" border=0>
              </td>
              <td data-fragment-index=2>⇆</td>
              <td data-fragment-index=1>
                <img class="element" src="database.png" alt="DB" border=0>
              </td>
            </tr>
          </table>
          <!-- TODO: картинка про конфликт -->
          <!-- TODO: картинка про решение конфликтов - миротворец -->
        </section>

        <section data-markdown>
          ## Данные без конфликтов
          ### CRDT — Conflict-free Replicated Data Type
          <!-- TODO: картинка, где данные держатся за ручки -->
          [hackage:crdt](https://hackage.haskell.org/package/crdt)
        </section>

        <section>
          <h2>Полурешётка</h2>
          <img
            alt="semilattice"
            class="element"
            src="semilattice.png"
            style="filter: invert(100%); box-shadow: none;">
        </section>

        <section>
          <p>
            <strong>Определение 1.</strong>
            Множество $A$ с операцией $(⋄)$ —
            <em class="term-def">полугруппа</em>,
            если эта операция <em class="term">ассоциативна</em>.
          </p>
          <p>
            <strong>Определение 2.</strong>
            Полугруппа $(A, (⋄))$ — <em class="term-def">полурешётка</em>,
            если эта эта операция <em class="term">коммутативна</em>
            и <em class="term">идемпотентна</em>.
          </p>
        </section>

        <section data-markdown>
          ## Идемпотентность

          $$
          x ⋄ x = x
          $$

          Синхронизация не портит данные
        </section>

        <section data-markdown>
          ## Коммутативность

          $$
          x ⋄ y = y ⋄ x
          $$

          Можно синхронизировать в любом направлении
        </section>

        <section data-markdown>
          ## Ассоциативность

          $$
          (x ⋄ y) ⋄ z = x ⋄ (y ⋄ z)
          $$

          Можно синхронизировать в любом порядке
        </section>

        <section data-markdown>
          ## Полурешётка =
          ## _Convergent_ RDT (CvRDT)
        </section>

        <section>
          <h2>(множества, $(\cup)$) — полурешётка</h2>

          $$
          (X \cup Y) \cup Z = X \cup (Y \cup Z) \\
          X \cup Y = Y \cup X \\
          X \cup X = X
          $$
        </section>

        <section>
          <h2>$(ℝ, \max)$ — полурешётка</h2>

          $$
          \max (\max (x, y), z) = \max (x, \max (y, z)) \\
          \max (x, y) = \max (y, x) \\
          \max (x, x) = x
          $$
        </section>

        <section>
          <h2>$(ℝ, (+))$ — полугруппа</h2>

          $$
          (x + y) + z = x + (y + z)
          $$

          <h2>но не полурешётка</h2>

          $$
          x + x \ne x
          $$
        </section>

        <section data-markdown>
          ## Полурешётка в Haskell

              class Semigroup a where
                  (&lt;>) :: a -> a -> a

              class Semigroup a => Semilattice a

              type CvRDT = Semilattice
        </section>

        <section data-markdown>
          ## `Set` — полурешётка

              instance Ord a => Semigroup (Set a) where
                  (&lt;>) = Set.union

              instance Ord a => Semilattice (Set a)

              -- instance Ord a => CvRDT (Set a) -- автоматически
        </section>

        <section data-markdown>
          ## `Max` — полурешётка

              newtype Max a = Max a

              instance Ord a => Semigroup (Max a) where
                  Max x &lt;> Max y = Max (max x y)

              instance Ord a => Semilattice (Max a)

              -- instance Ord a => CvRDT (Max a) -- автоматически
        </section>

        <section>
          <h2><code>LWW</code> (Last Write Wins)</h2>

          <pre><code>
            data LWW a = LWW
                { value     :: a
                , timestamp :: Timestamp
                }

            instance Ord (LWW a) where
                LWW{timestamp = t1} &lt;= LWW{timestamp = t2} =
                    t1 &lt;= t2

            instance Semigroup (LWW a) where
                (&lt;>) = max

            instance Semilattice (LWW a)

            -- instance CvRDT (LWW a) -- автоматически
          </code></pre>
        </section>

        <section>
          <h2>Пример из реальности — счётчик лайков</h2>

          <table class="td-center">
            <tr>
              <td>
                <code>
                  <span class=f3>[</span><span class=f1>(0,&nbsp;</span><span
                  class=f0>37175</span><span class=f1>)</span><span class=f3>,
                  &nbsp;(1,&nbsp;18267), &nbsp;(2,&nbsp;52733)]<br>&uarr;</span>
                </code>
              </td>
              <td>
                <code>
                  <span class=f3>[(0,&nbsp;37175),</span>
                  <span class=f1>&nbsp;(1,&nbsp;</span><span
                  class=f0>18267</span><span class=f1>)</span><span class=f3>,
                  &nbsp;(2,&nbsp;52733)]<br>&uarr;</span>
                </code>
              </td>
              <td>
                <code>
                  <span class=f3>[(0,&nbsp;37175), &nbsp;(1,&nbsp;18267),</span>
                  <span class=f1>&nbsp;(2,&nbsp;</span><span
                  class=f0>52733</span><span class=f1>)</span><span
                  class=f3>]<br>&uarr;</span>
                </code>
              </td>
            </tr>
          </table>

          <p class=f2>
            &darr;<br>
            <code>[(0, 37175), (1, 18267), (2, 52733)]</code>
          </p>
        </section>

        <section>
          <h2>Grow-only counter</h2>

          <pre><code>
            newtype GCounter = G (IntMap Natural)

            increment :: Int -> GCounter -> GCounter
            increment replicaId (G m) =
                G (IntMap.insertWith (+) replicaId 1 m)

            instance Semigroup GCounter where
                G x &lt;> G y = G (IntMap.unionWith max x y)

            instance Semilattice GCounter
          </code></pre>
        </section>

        <section data-markdown>
          ## Проблема CvRDT — размер пересылаемых данных
        </section>

        <section>
          <h2><em>Commutative</em> RDT (CmRDT)</h2>
          <img
            alt="CmRDT"
            class=element
            src="CmRDT-overview.svg"
            style="filter: invert(100%); box-shadow: none;">
        </section>

        <section>
          <pre><code>
            class CausalOrd a where
                affects :: a -> a -> Bool


            class CausalOrd op => CmRDT op where
                type Intent op

                type Payload op

                precondition :: Intent op -> Payload op -> Bool

                makeOp       :: Intent op -> Timestamp -> op

                apply        :: op -> Payload op -> Payload op
          </code></pre>
        </section>

        <section>
          <pre><code>
            data LWW a = LWW
                { value     :: a
                , timestamp :: Timestamp
                }

            instance CausalOrd (LWW a) where
                affects _ _ = False

            instance Eq a => CmRDT (LWW a) where
                type Intent  (LWW a) = a
                type Payload (LWW a) = LWW a
                makeOp = LWW
                apply = (&lt;>)
          </code></pre>
        </section>

        <section>
          <pre><code>
            data Counter = Increment | Decrement

            instance CausalOrd (LWW a) where
                affects _ _ = False

            instance CmRDT Counter where
                type Intent  Counter = Counter

                type Payload Counter = Integer

                apply op x = case op of
                    Increment -> x + 1
                    Decrement -> x - 1
          </code></pre>
        </section>

        <section>
          <pre><code>
            data TwoPSet a = Add a | Remove a

            instance Eq a => CausalOrd (TwoPSet a) where
                Remove a  `affects`  Add b  =  a == b
                _         `affects`  _      =  False

            instance Ord a => CmRDT (TwoPSet a) where
                type Intent  (TwoPSet a) = TwoPSet a

                type Payload (TwoPSet a) = Set a

                precondition (Add    _) _  ->  True
                precondition (Remove a) s  ->  Set.member a s

                apply (Add    a) s  =  Set.insert a s
                apply (Remove a) s  =  Set.delete a s
          </code></pre>
        </section>

        <section data-markdown>
          ## Проблема: законы классов не выражаются в Haskell
        </section>

        <section>
          <h2>Property-based testing</h2>

          <pre><code>
            associativity  =  \x y z  ->  (x &lt;> y) &lt;> z == x &lt;> (y &lt;> z)

            commutativity  =  \x y  ->  x &lt;> y == y &lt;> x

            idempotency    =  \x  ->  x &lt;> x == x
          </code></pre>
          <pre class="fragment"><code>
            associativity:
              +++ OK, passed 100 tests.
            commutativity:
              +++ OK, passed 100 tests.
            idempotency:
              +++ OK, passed 100 tests.
          </code></pre>
        </section>

        <!-- TODO: Type-level Haskell -->
        <!-- TODO: Liquid haskell -->
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
      document.querySelectorAll('[data-fragment-index]').forEach(e => {
        e.className += ' fragment';
      });

      document.querySelectorAll('code').forEach(e => {e.dataset.trim = '';});

      fragmentColors = ['#f55', '#ff5', '#5f5', '#5ff', '#55f', '#f5f'];
      for (var i = 0; i < 10; ++i) {
        document.querySelectorAll('[class=f' + i + ']').forEach(f => {
          f.className += ' fragment';
          f.dataset.fragmentIndex = i;
          f.style.color = fragmentColors[i];
        });
      }

      // More info about config & dependencies:
      // - https://github.com/hakimel/reveal.js#configuration
      // - https://github.com/hakimel/reveal.js#dependencies
      Reveal.initialize({
        dependencies: [
          {
            src: 'plugin/highlight/highlight.js',
            async: true,
            callback: function() {
              hljs.configure({languages: ['haskell']});
              hljs.initHighlightingOnLoad();
            }
          },
          { src: 'plugin/markdown/marked.js' },
          { src: 'plugin/markdown/markdown.js' },
          { src: 'plugin/math/math.js' },
          { src: 'plugin/notes/notes.js', async: true },
        ],
        history: true,
        slideNumber: true,
        transition: 'none',
      });
    </script>
  </body>
</html>
